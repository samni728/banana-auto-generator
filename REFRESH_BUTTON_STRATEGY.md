# 刷新按钮策略优化

## 问题分析

### 当前问题

当提示词提交后，如果在一定时间内没有返回生成图片：
- **当前策略**：重新提交提示词（`submitPromptWithRetry`）
- **问题**：
  1. 重复提交可能触发风控
  2. 不符合真实用户行为（用户看到没生成会点刷新，而不是重新输入）
  3. 增加请求频率，更容易被检测

### 用户建议

**优先点击刷新按钮**，而不是重新提交提示词：
- ✅ 更接近真实用户行为
- ✅ 不重复提交，减少请求频率
- ✅ 可能降低风控风险
- ✅ 更稳定的任务完成率

## 实现方案

### 1. 刷新按钮查找逻辑

```javascript
async function clickRefreshButton() {
  // 多种选择器策略：
  // 1. 标准选择器（class、aria-label）
  // 2. Material Design 图标查找
  // 3. 按钮图标匹配
  
  // 优先查找顺序：
  // - button[class*="refresh"]
  // - button[aria-label*="refresh"]
  // - .refresh-icon
  // - mat-icon.refresh-icon
}
```

### 2. 重试策略优化

**新的重试流程**：

```
1. 提交提示词
   ↓
2. 等待生成（60秒超时）
   ↓
3. 如果超时/失败
   ├─ 第一次/第二次尝试
   │  ├─ 优先：点击刷新按钮
   │  ├─ 等待10秒
   │  ├─ 检查是否生成成功
   │  └─ 如果成功 → 返回
   │  └─ 如果失败 → 继续等待
   └─ 第三次尝试
      └─ 等待后重试（不点击刷新）
   ↓
4. 如果所有重试都失败
   └─ 抛出错误
```

### 3. 关键改进

#### 3.1 优先刷新策略

```javascript
// 超时错误：优先点击刷新按钮
if (error.message.includes('超时')) {
  if (attempt <= 2 && !hasTriedRefresh) {
    // 优先点击刷新按钮
    const refreshClicked = await clickRefreshButton();
    if (refreshClicked) {
      await sleep(10000); // 等待10秒
      // 检查是否生成成功
      if (quickCheck.exists) {
        return quickCheck; // 成功！
      }
    }
  }
}
```

#### 3.2 避免重复刷新

```javascript
let hasTriedRefresh = false; // 记录是否已尝试刷新

// 确保每次重试只尝试一次刷新
if (attempt <= 2 && !hasTriedRefresh) {
  hasTriedRefresh = true;
  // 点击刷新...
}
```

#### 3.3 错误消息也尝试刷新

```javascript
// 检测到错误消息时，也尝试刷新
if (error.message.includes('错误消息')) {
  if (attempt <= 2 && !hasTriedRefresh) {
    await clickRefreshButton();
    // ...
  }
}
```

## 优势分析

### 1. 更接近真实用户行为

**真实用户行为**：
```
用户提交提示词 → 等待 → 没生成 → 点击刷新 → 等待 → 成功
```

**当前策略**：
```
提交提示词 → 等待 → 没生成 → 重新提交 → 等待 → 成功
```

**新策略**：
```
提交提示词 → 等待 → 没生成 → 点击刷新 → 等待 → 成功 ✅
```

### 2. 降低风控风险

| 策略 | 请求频率 | 风控风险 | 用户行为相似度 |
|------|---------|---------|---------------|
| 重新提交 | 高（重复提交） | 高 | 低 |
| 点击刷新 | 低（不重复提交） | 低 | 高 ✅ |

### 3. 提高任务完成率

- ✅ **刷新按钮**：Gemini可能只是暂时卡住，刷新后继续处理
- ✅ **重新提交**：可能创建新请求，导致重复或冲突

## 工作流程对比

### 旧流程（重新提交）

```
提交提示词1 → 等待60秒 → 超时
  ↓
重新提交提示词1 → 等待60秒 → 超时
  ↓
重新提交提示词1 → 等待60秒 → 成功
```

**问题**：
- 重复提交3次
- 可能触发风控
- 不符合用户行为

### 新流程（优先刷新）

```
提交提示词1 → 等待60秒 → 超时
  ↓
点击刷新按钮 → 等待10秒 → 检查 → 成功 ✅
```

**优势**：
- 只提交1次
- 点击刷新（用户行为）
- 更稳定

## 检测逻辑

### 刷新按钮检测

1. **标准选择器**：
   - `button[class*="refresh"]`
   - `button[aria-label*="refresh"]`
   - `.refresh-icon`

2. **Material Design**：
   - `button mat-icon.refresh-icon`
   - `.mat-icon.refresh-icon`

3. **图标匹配**：
   - 查找所有按钮
   - 检查是否包含刷新图标
   - 验证按钮可见且可用

### 刷新后验证

```javascript
// 点击刷新后
await sleep(10000); // 等待10秒

// 快速检查
const quickCheck = quickCheckImageExists(targetCount);
if (quickCheck.exists) {
  // 成功！
  return quickCheck;
}
```

## 预期效果

1. ✅ **降低风控风险**：不重复提交，减少请求频率
2. ✅ **提高成功率**：刷新可能恢复卡住的请求
3. ✅ **更稳定**：更接近真实用户行为
4. ✅ **更好的用户体验**：任务完成率更高

## 注意事项

1. **刷新按钮可能不存在**：
   - 如果找不到刷新按钮，回退到等待重试策略
   - 不会影响正常流程

2. **刷新后等待时间**：
   - 10秒等待时间，给Gemini足够时间重新生成
   - 如果仍然失败，继续重试

3. **避免重复刷新**：
   - 使用 `hasTriedRefresh` 标志
   - 每次重试只尝试一次刷新

## 总结

**新策略的核心优势**：
- ✅ 优先点击刷新按钮（用户行为）
- ✅ 避免重复提交提示词（降低风控风险）
- ✅ 更稳定的任务完成率
- ✅ 更符合真实用户操作习惯

这个策略应该能够显著提高任务完成率，同时降低触发风控的风险。

