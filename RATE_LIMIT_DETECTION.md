# 风控/速率限制检测说明

## Log 分析

### 1. CSP (Content Security Policy) 违规

```
Fetch API cannot load https://www.googleadservices.com/pagead/conversion/...
Refused to connect because it violates the document's Content Security Policy.
```

**含义**：这是**正常的浏览器安全策略警告**，不是风控。

- Gemini页面设置了CSP，阻止加载某些广告服务
- 这是页面本身的安全策略，不是针对你的限制
- **可以忽略**

### 2. 非被动事件监听器警告

```
[Violation] Added non-passive event listener to a scroll-blocking 'touchstart' event.
```

**含义**：这是**浏览器性能优化建议**，不是风控。

- 浏览器建议使用passive事件监听器以提升性能
- 这是Gemini页面代码的问题，不是你的扩展导致的
- **可以忽略**

### 3. "用户停止"

```
[Content] 等待生成失败 (尝试 1/3): 用户停止
[Content] 第 5 张图片生成失败: 用户停止
```

**含义**：这是**用户手动停止**，不是风控。

- 用户点击了"停止"按钮
- 这是正常的操作，不是被限制
- **正常行为**

## 真正的风控迹象

### 1. Google "Sorry" 页面

如果看到以下情况，说明**可能被风控**：

```
URL包含: google.com/sorry
页面标题: "Sorry..." 或 "验证"
页面内容: "Our systems have detected unusual traffic"
```

### 2. 验证码出现

```
页面出现: reCAPTCHA 验证码
需要手动验证才能继续
```

### 3. 输入框被禁用

```
输入框无法编辑
提示: "暂时无法使用" 或 "unavailable"
```

### 4. 速率限制消息

```
页面显示: "Too many requests" 或 "请求过多"
或: "Rate limit exceeded"
```

## 检测功能

已添加 `detectRateLimitOrBlock()` 函数，会自动检测：

1. ✅ **Sorry页面检测**：检查URL和页面标题
2. ✅ **验证码检测**：查找captcha元素
3. ✅ **输入框禁用检测**：检查输入框状态
4. ✅ **速率限制消息检测**：查找相关提示文本

## 工作流程

```
1. 提交提示词前
   ↓
2. 检测是否被风控
   ├─ 如果检测到 → 等待10秒后重试
   └─ 如果仍然被限制 → 抛出错误，建议稍后再试
   ↓
3. 等待生成时（每5次检查一次）
   ↓
4. 检测是否被风控
   ├─ 如果检测到 → 立即停止，提示用户
   └─ 如果正常 → 继续等待
```

## 建议

1. **CSP和事件监听器警告**：可以忽略，这是正常的浏览器警告
2. **如果检测到风控**：
   - 等待更长时间（15-25秒的随机等待已经实现）
   - 如果持续被限制，建议暂停一段时间
   - 检查是否有验证码需要手动完成

3. **预防措施**：
   - ✅ 已实现：每张图后随机等待15-25秒
   - ✅ 已实现：减少DOM查询频率
   - ✅ 已实现：自动检测风控状态

## 总结

**你看到的log不是风控**，而是：
- ✅ 正常的浏览器安全策略警告（CSP）
- ✅ 正常的浏览器性能建议（事件监听器）
- ✅ 用户手动停止操作

**真正的风控会显示**：
- ❌ Google Sorry页面
- ❌ 验证码
- ❌ 输入框被禁用
- ❌ 速率限制消息

现在代码已经添加了自动检测功能，如果真正被风控，会及时提示并处理。

